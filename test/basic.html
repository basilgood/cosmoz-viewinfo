<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
		/>
		<title>cosmoz-viewinfo basic test</title>

		<script src="/components/@webcomponents/webcomponentsjs/webcomponents-loader.js"></script>
		<script src="/components/@polymer/test-fixture/test-fixture.js"></script>
		<script src="/components/mocha/mocha.js"></script>
		<script src="/components/chai/chai.js"></script>
		<script src="/components/wct-mocha/wct-mocha.js"></script>
	</head>
	<body>
		<test-fixture id="basic">
			<template>
				<cosmoz-viewinfo style="display:block;width:100px">
					<helper-element></helper-element>
				</cosmoz-viewinfo>
			</template>
		</test-fixture>

		<test-fixture id="noinstances">
			<template>
				<cosmoz-viewinfo style="display:block;width:100px"></cosmoz-viewinfo>
			</template>
		</test-fixture>

		<test-fixture id="zerowidth">
			<template>
				<cosmoz-viewinfo style="display:block;width:0px;font-size: 0px">
					<helper-element></helper-element>
				</cosmoz-viewinfo>
			</template>
		</test-fixture>

		<script type="module">
			import { PolymerElement, html } from "@polymer/polymer/polymer-element";
			import { CosmozViewInfo, viewInfoAware } from "../cosmoz-viewinfo.js";
			import { flush } from "@polymer/polymer/lib/utils/flush.js";

			class HelperElement extends viewInfoAware(PolymerElement) {
				static get template() {
					return html`
						<span>[[ viewInfo.width ]]</span>
						<span>[[ viewInfo.mobile ]]</span>
						<span>[[ viewInfo.tablet ]]</span>
						<span>[[ viewInfo.desktop ]]</span>
					`;
				}

				_attachDom(dom) {
					this.appendChild(dom);
				}
			}
			customElements.define("helper-element", HelperElement);

			suite("<cosmoz-viewinfo>", () => {
				let viewInfo;

				setup(() => {
					viewInfo = fixture("basic");
				});

				test("it works", () => {
					assert.instanceOf(viewInfo, CosmozViewInfo);
				});

				test("calculates view information on resize", () => {
					assert.equal(viewInfo.innerText, "100 true false false");

					viewInfo.style.width = "700px";
					viewInfo.dispatchEvent(new CustomEvent("iron-resize"));
					flush();
					assert.equal(viewInfo.innerText, "700 false true false");

					viewInfo.style.width = "1000px";
					viewInfo.dispatchEvent(new CustomEvent("iron-resize"));
					flush();
					assert.equal(viewInfo.innerText, "1000 false false true");
				});
			});

			suite("<cosmoz-viewinfo>", () => {
				let viewInfo;

				setup(() => {
					viewInfo = fixture("noinstances");
				});

				test("new elements created after resize have correct view info", () => {
					// the viewinfo element is resized
					viewInfo.style.width = "700px";
					viewInfo.dispatchEvent(new CustomEvent("iron-resize"));
					flush();

					// a view info aware element is added to the page
					viewInfo.appendChild(document.createElement("helper-element"));

					// assert that the view information is correct
					assert.equal(viewInfo.innerText, "700 false true false");
				});
			});

			suite("<cosmoz-viewinfo>", () => {
				let viewInfo;

				setup(() => {
					viewInfo = fixture("zerowidth");
				});

				test("it works when viewport width is zero", () => {
					// the viewinfo element is zero
					assert.equal(viewInfo.innerText, "0 true false false");

					// the viewinfo element is 100px
					viewInfo.style.width = "100px";
					viewInfo.dispatchEvent(new CustomEvent("iron-resize"));
					flush();
					assert.equal(viewInfo.innerText, "100 true false false");

					// the viewinfo element is zero again
					viewInfo.style.width = "0px";
					viewInfo.dispatchEvent(new CustomEvent("iron-resize"));
					flush();
					assert.equal(viewInfo.innerText, "0 true false false");
				});
			});
		</script>
	</body>
</html>
